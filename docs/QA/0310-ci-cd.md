# CI/CD Testing - SiswaPresensi

## Dokumen Kontrol | Informasi Dokumen
| | |
--- | --- |
**Judul** | CI/CD Testing SiswaPresensi |
**Tanggal** | 16 Februari 2026 |
**Status** | Draft |
**Versi** | 1.0 |
**Dipersiapkan untuk**| SiswaPresensi Project |
**Penulis** | QA Engineer |

---

## 1. Tujuan Dokumen

Dokumen ini mendefinisikan strategi CI/CD testing untuk SiswaPresensi, mencakup automated testing pipeline, quality gates, dan deployment process.

---

## 2. CI/CD Pipeline Overview

### 2.1 Pipeline Stages

```
┌─────────────────────────────────────────────────────────────────┐
│                        CI/CD Pipeline                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │
│  │   Build     │ -> │   Test      │ -> │  Security   │       │
│  │             │    │             │    │             │       │
│  │ - Install   │    │ - Unit      │    │ - Scan      │       │
│ 1 │ - Compile   │    │ - Integration│   │ - Audit     │       │
│  │ - Lint      │    │ - E2E       │    │ - Check     │       │
│  └─────────────┘    └─────────────┘    └─────────────┘       │
│         │                  │                  │                │
│         v                  v                  v                │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │
│  │   Quality   │ -> │  Deploy     │ -> │  Monitor   │       │
│  │             │    │             │    │             │       │
│  │ - Coverage  │    │ - Staging   │    │ - Health    │       │
│  │ - Performance│   │ - Production│    │ - Alerts    │       │
│  │ - Accessibility│ │ - Rollback  │    │ - Metrics   │       │
│  └─────────────┘    └─────────────┘    └─────────────┘       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. GitHub Actions Workflow

### 3.1. Pull Request Workflow

```yaml
# .github/workflows/pr.yml
name: Pull Request

on:
  pull_request:
    branches: [develop, main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath
          coverage: xdebug

      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Run PHP CS Fixer
        run: vendor/bin/php-cs-fixer fix --dry-run --diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install NPM Dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath
          coverage: xdebug

      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Copy Environment
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Create Database
        run: |
          sudo systemctl start mysql
          mysql -e 'CREATE DATABASE siswapresensi_test;' -uroot -proot

      - name: Run Migrations
        run: php artisan migrate --force

      - name: Run Unit Tests
        run: php artisan test --testsuite=Unit --coverage-clover=coverage.xml

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unit-tests
          name: codecov-unit-tests

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath
          coverage: xdebug

      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Copy Environment
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Create Database
        run: |
          sudo systemctl start mysql
          mysql -e 'CREATE DATABASE siswapresensi_test;' -uroot -proot

      - name: Run Migrations
        run: php artisan migrate --force

      - name: Run Integration Tests
        run: php artisan test --testsuite=Feature --coverage-clover=coverage.xml

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: integration-tests
          name: codecov-integration-tests

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath

      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Copy Environment
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Create Database
        run: |
          sudo systemctl start mysql
          mysql -e 'CREATE DATABASE siswapresensi_test;' -uroot -proot

      - name: Run Migrations
        run: php artisan migrate --force

      - name: Seed Database
        run: php artisan db:seed

      - name: Start Server
        run: php artisan serve --host=0.0.0.0 --port=8000 &
        env:
          DATABASE_URL: mysql://root:root@localhost/siswapresensi_test

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install NPM Dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run E2E Tests
        run: npm run test:e2e

      - name: Upload E2E Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto

      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --memory-limit=2G

      - name: Check for vulnerabilities
        run: composer audit

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'performance')
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath

      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Copy Environment
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key: generate

      - name: Create Database
        run: |
          sudo systemctl start mysql
          mysql -e 'CREATE DATABASE siswapresensi_test;' -uroot -proot

      - name: Run Migrations
        run: php artisan migrate --force

      - name: Seed Database
        run: php artisan db:seed

      - name: Start Server
        run: php artisan serve --host=0.0.0.0 --port=8000 &
        env:
          DATABASE_URL: mysql://root:root@localhost/siswapresensi_test

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C418C0FAD96F
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run Performance Tests
        run: k6 run tests/performance/normal-load.js
```

### 3.2. Deployment Workflow

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.siswapresensi.com
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2''

      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Run Tests
        run: php artisan test

      - name: Deploy to Staging
        run: |
          # Add deployment commands here
          echo "Deploying to staging..."

      - name: Run Smoke Tests
        run: npm run test:smoke

      - name: Notify Team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Deployment to staging completed'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
      url: https://siswapresensi.com
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Run Tests
        run: php artisan test

      - name: Create Backup
        run: |
          # Add backup commands here
          echo "Creating backup..."

      - name: Deploy to Production
        run: |
          # Add deployment commands here
          echo "Deploying to production..."

      - name: Run Smoke Tests
        run: npm run test:smoke

      - name: Notify Team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Deployment to production completed'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

---

## 4. Quality Gates

### 4.1 Pre-Commit Hooks

```yaml
# .husky/pre-commit
#!/bin/sh

# Run PHP CS Fixer
vendor/bin/php-cs-fixer fix --dry-run --diff

# Run ESLint
npm run lint

# Run unit tests
php artisan test --testsuite=Unit
```

### 4.2 Pre-Push Hooks

```yaml
# .husky/pre-push
#!/bin/sh

# Run all tests
php artisan test

# Run type checking
vendor/bin/phpstan analyse

# Check for vulnerabilities
composer audit
```

### 4.3 Quality Gate Criteria

| Gate | Criteria | Action |
|------|----------|--------|
| **Lint** | No linting errors | Fail build |
| **Unit Tests** | All tests pass, coverage > 80% | Fail build |
| **Integration Tests** | All tests pass | Fail build |
| **E2E Tests** | All tests pass | Fail build |
| **Security Scan** | No critical vulnerabilities | Fail build |
| **Performance Tests** | p95 < 500ms for critical APIs | Fail build |
| **Type Checking** | No type errors | Fail build |

---

## 5. Deployment Strategy

### 5.1 Blue-Green Deployment

```
┌─────────────────────────────────────────────────────────────────┐
│                     Blue-Green Deployment                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. Deploy to Green (inactive)                                  │
│     ┌─────────────┐    ┌─────────────┐                          │
│     │   Blue      │    │   Green     │                          │
│     │  (Active)   │    │ (Inactive)  │                          │
│     │  v1.0.0     │    │  v1.1.0     │                          │
│     └─────────────┘    └─────────────┘                          │
│           │                  │                                    │
│           └────────┬─────────┘                                    │
│                    │                                             │
│                    v                                             │
│  2. Switch Traffic to Green                                     │
│     ┌─────────────┐    ┌─────────────┐                          │
│     │   Blue      │    │   Green       │                         │
│     │ (Inactive)  │    │  (Active)    │                         │
│     │  v1.0.0     │    │  v1.1.0      │                         │
│     └─────────────┘    └─────────────┘                          │
│           │                  │                                    │
│           └────────┬─────────┘                                    │
│                    │                                             │
│                    v                                             │
│  3. Monitor and Rollback if Needed                               │
│     ┌─────────────┐    ┌─────────────┐                          │
│     │   Blue      │    │   Green     │                          │
│     │ (Inactive)  │    │  (Active)    │                         │
│     │  v1.0.0     │    │  v1.1.0      │                         │
│     └─────────────┘    └─────────────┘                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 Rollback Strategy

```yaml
# .github/workflows/rollback.yml
name: Rollback

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to rollback: to'
        required: true
        type: string

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://siswapresensi.com
    steps:
      - uses: actions/checkout@v4

      - name: Rollback to Version
        run: |
          # Add rollback commands here
          echo "Rolling back to ${{ github.event.inputs.version }}..."

      - name: Run Smoke Tests
        run: npm run test:smoke

      - name: Notify Team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Rollback to ${{ github.event.inputs.version }} completed'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

---

## 6. Monitoring & Alerts

### 6.1 Health Checks

```php
// routes/api.php
Route::get('/health', function () {
    return response()->json([
        'status' => 'ok',
        'timestamp' => now()->toIso8601String(),
        'version' => config('app.version'),
        'database' => DB::connection()->getPdo() ? 'connected' : 'disconnected',
        'cache' => Cache::get('health_check') ? 'connected' : 'disconnected',
    ]);
});
```

### 6.2 Monitoring Setup

```yaml
# docker-compose.monitoring.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana

  alertmanager:
    image: prom/alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml

volumes:
  grafana-data:
```

### 6.3 Alert Rules

```yaml
# alertmanager.yml
groups:
  - name: siswapresensi
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, http_request_duration_seconds) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High response time detected"

      - alert: DatabaseConnectionFailure
        expr: up{job="mysql"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Database connection failure"

      - alert: LowMemory
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low memory available"
```

---

## 7. Test Reports

### 7.1 Test Results Dashboard

```javascript
// Generate test results summary
const generateTestSummary = (results) => {
  return {
    total: results.total,
    passed: results.passed,
    failed: results.failed,
    skipped: results.skipped,
    duration: results.duration,
    coverage: {
      statements: results.coverage.statements,
      branches: results.coverage.branches,
      functions: results.coverage.functions,
      lines: results.coverage.lines,
    },
    performance: {
      p50: results.performance.p50,
      p95: results.performance.p95,
      p99: results.performance.p99,
    },
  };
};
```

### 7.2 Weekly Test Report

```markdown
# CI/CD Test Report - Week 7, 2024

## Summary

| Metric | This Week | Last Week | Change |
|--------|-----------|-----------|--------|
| Total Tests | 245 | 230 | +6.5% |
| Passed | 240 | 225 | +6.7% |
| Failed | 5 | 5 | 0% |
| Skipped | 0 | 0 | 0% |
| Duration | 8m 30s | 7m 45s | +8.5% |
| Coverage | 85% | 83% | +2% |

## Test Categories

| Category | Total | Passed | Failed | Coverage |
|----------|-------|--------|--------|----------|
| Unit Tests | 150 | 148 | 2 | 90% |
| Integration Tests | 70 | 68 | 2 | 85% |
| E2E Tests | 25 | 24 | 1 | - |

## Failed Tests

1. `test_qr_code_expiry` - QR code expiry not working correctly
2. `test_reverse_marking_bulk` - Bulk reverse marking failing
3. `test_report_generation` - Report generation timeout
4. `test_performance_p95` - p95 response time exceeded
5. `test_accessibility_color_contrast` - Color contrast issue

## Performance Metrics

| Metric | Target | Actual | Status |
|--------|--------|--------|--------|
| p50 Response Time | < 200ms | 180ms | ✅ |
| p95 Response Time | < 500ms | 520ms | ❌ |
| p99 Response Time | < 1000ms | 950ms | ✅ |
| Throughput | > 100 req/sec | 120 req/sec | ✅ |

## Security Scan

| Category | Critical | High | Medium | Low |
|----------|----------|------|'--------|-----|
| SQL Injection | 0 | 0 | 0 | 0 |
| XSS | 0 | 0 | 0 | 0 |
| CSRF | 0 | 0 | 0 | 0 |
| Authentication | 0 | 0 | 1 | 2 |
| Authorization | 0 | 0 | 0 | 0 |

## Recommendations

1. Fix QR code expiry issue
2. Fix bulk reverse marking
3. Optimize report generation
4. Improve p95 response time
5. Fix color contrast issue
6. Address medium severity authentication issues

## Next Steps

1. Fix failed tests
2. Improve performance
3. Address security issues
4. Increase test coverage
5. Optimize test duration
```

---

## 8. Best Practices

### 8.1 CI/CD Best Practices

- **Automate everything** - Automate build, test, deploy
- **Fast feedback** - Provide quick feedback to developers
- **Parallel execution** - Run tests in parallel
- **Caching** - Cache dependencies to speed up builds
- **Artifacts** - Save test results and artifacts
- **Notifications** - Notify team of build status
- **Rollback plan** - Always have rollback plan ready
- **Monitor** - Monitor production continuously
- **Security** - Scan for vulnerabilities regularly
- **Documentation** - Document CI/CD process

### 8.2 Testing Best Practices

- **Test early** - Write tests during development
- **Test often** - Run tests frequently
- **Test everything** - Test all critical paths
- **Keep tests fast** - Optimize test performance
- **Use test data** - Use factories and seeders
- **Mock external dependencies** - Mock APIs, services
- **Test in isolation** - Keep tests independent
- **Use descriptive names** - Make tests self-documenting
- **Maintain tests** - Keep tests up to date
- **Review tests** - Review tests in code review

---

## 9. Troubleshooting

### 9.1 Common Issues

**Issue:** Build failing on linting
**Solution:** Fix linting errors locally before pushing

```bash
# Fix PHP linting
vendor/bin/php-cs-fixer fix

# Fix JavaScript linting
npm run lint --fix
```

**Issue:** Tests failing in CI but passing locally
**Solution:** Check environment differences

```bash
# Check PHP version
php -v

# Check database connection
php artisan tinker
DB::connection()->getPdo()

# Check environment variables
php artisan env
```

**Issue:** Slow test execution
**Solution:** Optimize tests and use parallel execution

```bash
# Run tests in parallel
php artisan test --parallel

# Run specific test suite
php artisan test --testsuite=Unit
```

---

## 10. Documentation

### 10.1 CI/CD Documentation

- Document pipeline stages
- Document quality gates
- Document deployment process
- Document rollback procedure
- Document monitoring setup
- Document alert rules
- Document troubleshooting steps

### 10.2 Test Documentation

- Document test strategy
- Document test scenarios
- Document test data
- Document test coverage
- Document test results
- Document test maintenance

---

## Dokumentasi Terkait
- [Test Strategy](./0301-test-strategy.md)
- [Unit Tests](./0302-unit-tests.md)
- [Integration Tests](./0303-integration-tests.md)
- [E2E Tests](./0304-e2e-tests.md)
- [Performance Tests](./0305-performance-tests.md)
- [Security Tests](./0306-security-tests.md)
- [Accessibility Tests](./0307-accessibility-tests.md)
- [Bug Reporting](./0308-bug-reporting.md)
- [Acceptance Criteria](./0309-acceptance-criteria.md)
